<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Gestual Anime - Inspirado en Kazuma</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #input_video { position: absolute; top: 0; left: 0; visibility: hidden; }
        #ui-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <video id="input_video" autoplay playsinline></video>
    <div id="ui-container">
        <button id="reset-btn">Resetear Avatar</button>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        // Configura la escena 3D con Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2; // Acercamos un poco para ver bien la cabeza
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luz para ver el modelo
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(0, 1, 1);
        scene.add(directionalLight);

        // Carga el modelo GLTF (el avatar anime similar a Kazuma)
        let avatar;
        const loader = new THREE.GLTFLoader();
        loader.load('avatar.glb', (gltf) => {
            avatar = gltf.scene;
            avatar.scale.set(1, 1, 1); // Ajusta tamaño si es necesario
            scene.add(avatar);

            // Para hacerlo más como Kazuma: cambia color de pelo si el modelo tiene materiales (ejemplo, si el pelo es un mesh llamado 'hair')
            const hair = avatar.getObjectByName('hair'); // Cambia 'hair' al nombre real del mesh en el modelo
            if (hair) {
                hair.material.color.set(0x8B4513); // Castaño para pelo de Kazuma
            }
        });

        // Configura MediaPipe FaceMesh
        const videoElement = document.getElementById('input_video');
        const faceMesh = new FaceMesh({ 
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` 
        });
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        faceMesh.onResults(onResults);

        // Inicia la cámara
        const mpCamera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({ image: videoElement });
            },
            width: 1280,
            height: 720
        });
        mpCamera.start();

        // Función para procesar resultados de FaceMesh
        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                if (avatar) {
                    // Rotación de la cabeza (usa landmarks para calcular yaw, pitch, roll)
                    const nose = landmarks[1]; // Punta de nariz
                    const leftEar = landmarks[234]; // Oreja izquierda approx
                    const rightEar = landmarks[454]; // Oreja derecha

                    // Simple rotación: yaw (izq-der) basado en diferencia X
                    const yaw = (leftEar.x - rightEar.x) * Math.PI;
                    const pitch = (nose.y - (leftEar.y + rightEar.y)/2) * Math.PI;
                    avatar.rotation.y = yaw;
                    avatar.rotation.x = pitch;

                    // Parpadeo: distancia entre landmarks de ojos
                    const leftEyeTop = landmarks[159];
                    const leftEyeBottom = landmarks[145];
                    const blinkThreshold = 0.01; // Ajusta
                    const blink = Math.abs(leftEyeTop.y - leftEyeBottom.y) < blinkThreshold;

                    // Si parpadea, cierra ojos (si el modelo tiene meshes de ojos)
                    const eyes = avatar.getObjectByName('eyes'); // Asume nombre, ajusta
                    if (eyes) {
                        eyes.visible = !blink; // O escala para cerrar
                    }

                    // Boca abierta: distancia entre labios
                    const upperLip = landmarks[13];
                    const lowerLip = landmarks[14];
                    const mouthOpen = Math.abs(upperLip.y - lowerLip.y) > 0.03;
                    const jaw = avatar.getObjectByName('jaw'); // Si tiene hueso de mandíbula
                    if (jaw) {
                        jaw.rotation.x = mouthOpen ? 0.3 : 0; // Abre mandíbula
                    }
                }
            }
        }

        // Bucle de animación
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // Botón de reset
        document.getElementById('reset-btn').addEventListener('click', () => {
            if (avatar) {
                avatar.rotation.set(0, 0, 0);
            }
        });
    </script>
</body>
</html>
